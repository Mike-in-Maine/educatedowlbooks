{% extends "main/base.html" %}

{% block title %}Upload Inventory{% endblock %}

{% block content %}

<h1>Upload Your Inventory</h1>

<p style="max-width: 700px; line-height: 1.5;">
    <strong>No special CSV format required.</strong><br>
    You don’t need to rename columns or prepare your file in any specific way.
    Our system analyzes your CSV and recognizes common inventory fields
    such as ISBN, title, author, price, condition, and quantity.
</p>

<p style="max-width: 700px; line-height: 1.5;">
    This is a short, one-time setup process:
</p>

<ol style="max-width: 700px; line-height: 1.5;">
    <li>You upload a CSV file in any reasonable format.</li>
    <li>We identify how each column is being used.</li>
    <li>You review and confirm the mapping.</li>
    <li>Once confirmed, we remember this structure for future uploads.</li>
</ol>

<p style="max-width: 700px; line-height: 1.5;">
    You can review or change your column mapping at any time.
</p>

<hr>

<form method="post" enctype="multipart/form-data" style="margin-top: 1.5rem;">
    {% csrf_token %}

    <div style="margin-bottom: 1rem;">
        <label>
            <strong>Select CSV file:</strong><br>
            <input type="file" name="file" accept=".csv" required>
        </label>
    </div>

    <button type="submit" class="btn btn-primary">
        Upload CSV
    </button>
</form>

{% if preview %}
    <hr>

    <h3>Inventory Preview</h3>
    <p>
        Please review how your inventory will be interpreted before publishing.
    </p>

    <p>
        <strong>Sample size:</strong> {{ preview.summary.sample_size }}<br>
        <strong>Matched books:</strong> {{ preview.summary.matched_books }}<br>
        <strong>Missing books:</strong> {{ preview.summary.missing_books }}
    </p>

    <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse;">
        <thead>
            <tr>
                <th>Row</th>
                <th>ISBN</th>
                <th>Matched Book</th>
            </tr>
        </thead>
        <tbody>
            {% for row in preview.rows %}
                <tr>
                    <td>{{ row.row }}</td>
                    <td>
                        {{ row.isbn10|default:row.isbn13 }}
                    </td>
                    <td>
                        {% if row.book_id %}
                            {{ row.book_title }} — {{ row.book_author }}
                        {% else %}
                            <span style="color: #b00020;">Not found</span>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <form method="post" action="{% url 'confirm_inventory' %}" style="margin-top: 1.5rem;">
        {% csrf_token %}
        <button type="submit" class="btn btn-success">
            Confirm & Publish Inventory
        </button>
    </form>
{% endif %}

{% endblock %}
