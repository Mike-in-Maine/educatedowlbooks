
====================
FILE: biblio_raw_9780141439808.html
====================
<!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="robots" content="noindex,nofollow"><meta name="viewport" content="width=device-width,initial-scale=1"><style>*{box-sizing:border-box;margin:0;padding:0}html{line-height:1.15;-webkit-text-size-adjust:100%;color:#313131;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"}body{display:flex;flex-direction:column;height:100vh;min-height:100vh}.main-content{margin:8rem auto;padding-left:1.5rem;max-width:60rem}@media (width <= 720px){.main-content{margin-top:4rem}}.h2{line-height:2.25rem;font-size:1.5rem;font-weight:500}@media (width <= 720px){.h2{line-height:1.5rem;font-size:1.25rem}}#challenge-error-text{background-image:url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0ibm9uZSI+PHBhdGggZmlsbD0iI0IyMEYwMyIgZD0iTTE2IDNhMTMgMTMgMCAxIDAgMTMgMTNBMTMuMDE1IDEzLjAxNSAwIDAgMCAxNiAzbTAgMjRhMTEgMTEgMCAxIDEgMTEtMTEgMTEuMDEgMTEuMDEgMCAwIDEtMTEgMTEiLz48cGF0aCBmaWxsPSIjQjIwRjAzIiBkPSJNMTcuMDM4IDE4LjYxNUgxNC44N0wxNC41NjMgOS41aDIuNzgzem0tMS4wODQgMS40MjdxLjY2IDAgMS4wNTcuMzg4LjQwNy4zODkuNDA3Ljk5NCAwIC41OTYtLjQwNy45ODQtLjM5Ny4zOS0xLjA1Ny4zODktLjY1IDAtMS4wNTYtLjM4OS0uMzk4LS4zODktLjM5OC0uOTg0IDAtLjU5Ny4zOTgtLjk4NS40MDYtLjM5NyAxLjA1Ni0uMzk3Ii8+PC9zdmc+");background-repeat:no-repeat;background-size:contain;padding-left:34px}@media (prefers-color-scheme: dark){body{background-color:#222;color:#d9d9d9}}</style><meta http-equiv="refresh" content="360"></head><body><div class="main-wrapper" role="main"><div class="main-content"><noscript><div class="h2"><span id="challenge-error-text">Enable JavaScript and cookies to continue</span></div></noscript></div></div><script>(function(){window._cf_chl_opt = {cvId: '3',cZone: 'www.biblio.com',cType: 'managed',cRay: '9bc4ed8f4e07c410',cH: 'vRo5RGx6N9vnPoDDZoo2byn0k2PZB4ruTHlIoPYVqdI-1768139896-1.2.1.1-VNgGRO48D5X9ZlSbQZlzyEVcPvnHX0_vVEm.9JZxjpNAdWC8tjx5VBXpvUNLP7it',cUPMDTk:"\/9780141439808?__cf_chl_tk=_LY3Mgvpzv9UZHQNvAOWrCLe6JnE0Xn9_HEIfxyZdRg-1768139896-1.0.1.1-gOR5PQaITjvin.z07Qv9vJwxeVGRWdmuEhPAQgjV1Xg",cFPWv: 'g',cITimeS: '1768139896',cTplC:0,cTplV:5,cTplB: '0',fa:"\/9780141439808?__cf_chl_f_tk=_LY3Mgvpzv9UZHQNvAOWrCLe6JnE0Xn9_HEIfxyZdRg-1768139896-1.0.1.1-gOR5PQaITjvin.z07Qv9vJwxeVGRWdmuEhPAQgjV1Xg",md: 'wFUOuXJePtKzhL_L2zC81Bf_kl7tMz1gsQJ4JCg3ZAU-1768139896-1.2.1.1-vJCbygBcbehbefCQf5MISDahYRwtNmRMXYCWAChFOnGijNJPejQzI0VFubYSYTk2O3xwHk.ej2aL_8acHor7sHDezUZgoilshy5ZgR6OaDGQPJ9vUii4FLO4W6GCyCAAsT0R6iZFudFGVKJv6NbyrTD.x3ZLtKMRE.l.7y6L21m3qEDGSO.qwi6xDiCJfvuxuvAM5XIf2d7s.Ff3Ko8obChe50aPimujyTWcQWfKznNPffqDwVGlRn9UHCV_T7AIF7FA_QE3CNzYREHG302tEEjvKtO_A8UIiVFJ1Kh6KfvdhZd50P3YX1WP4Jvv3cv67wetiE0cvwnB2KQNqtXRVXlSHE8NXTZ9HtT2gA7NgQiQUAfXJXXIKXt5_hZBkxEET5.wNrHAOGKpfzyn7EfZWadeJLiYhhHsl.MjJWyDixvXRnYK9ste0lZG2NbN.uFAqGpNHY4TgN9eTBPZM7VKC4dnBbCJuTLntH0e9MOL4C0WgUCmyWhW6b2tODTPpfCNLJwpwv3LX3Iyg3bTDmd_wIfzPTGDG2GNOmCcOfL2Lo8IoltKPO.iz9dtc0BMgvviYW4Yn1QEheaQLu24W9VZEe3HwXK4A44MEMDyy._WcwO5y1yM7qi3g0cv2c1b2FTGa1RSDZVrnHF4pgTUn_7Cxglp8uMiiA8ngI_gp5XXIFnzZ.f_cqxi9ocnSIkXTkeckrV48TVvQQypFdKmdt.iDkUpuxtyd6YUmQso4aJRrg1naQyHuiPfBnFLY4Hy2UdLafPZUxBOBWtC_pjqwtWDzWA59VDVb1xOdxRlPRIOg4ovDiRm2dar0amE3SoA2_eGdG7Uw2RVlq796uO4pdhAesHyNmKtn0t0a2BZ4JSOyugOALziHtryis3ISWK10pu11c4FzZqU5b5Z9QtdDzMOmsTxbHDLK8LPa6QOqRIVEsnsqpYvNfD8Ce11n.KZHQqfWb14Puf3Tho4I5mxx4ZNTdyXZ9nR8vIw8WWiWlwGF3j8T.8pJVBPvyGv.sVRcV0y3yeZ.rgwfFr6M6mYBzd44PWkRIqx8d4xaVdnTHCcOHs',mdrd: 'h_0NAsMr.ZuOQWpdG4Np.yFsxbzMxEDG2aLFK5Ckyvc-1768139896-1.2.1.1-Ylu__3MK9ay7JL7wup89vSMElbKj8ITtSruUQE4pZdCYWAJ_0enjWevg8yA1PKCgFpMuTLj1nv1KbnIe0fT5qpXRhmmyRm9PZT3kHlvyXxQAh34I0ejcIzQGJwaGxkvnMl4HVZpSZCzPLFUyfsAaFcWF5ZVz48brf4BVhYPaCCdoXHnpoblHyNr2Cen5Tfk_gZqKHJxs2OwbQ6XJglIhRQEz5sRjKNgYN5ag7eWsBGBTNJQBufiFOjpAs4sp2wP3vQG3PGI2dYan8yWFRAAfxefWv7gakonsi5IYdPyPVoWse4eAE7N.uQN9Jqy0rlEqrGxwTRiHftAxUDVN6owVnaRKQ1JMNqK.JIEwiDMCBuGvmbig2tWatoQQiHogCxjvQirGykObfkwoNaX4bPMXNkO.REofSNGjUcSrwJwYMmQ90OtraZSZETE6tWY66Al3ljskG8lvKeq9Pbrw1tmgw6Ag8FcNiyt_t0UERTp.rGWD3YR6advCpl.BkYCqn7bvsZa.IBqhvpjmSuv9UGuzimciZclrWtH6lXcn_jYfHDlwedh4tajVJtht5q0x2ESFhxaZlKLuWNr_UIDP0Vuh6dcFQEFPhRd4pQX.XPJnbTwt4CdB5EBV5su8d9tLlsEKr_oLqTpweqrmcgl3gvW82ATY6uo2oVoF.TMg2_xpkOf343hCAuPWDAzowNz3Oneg5h9dQ02mzgu2V5VZOZw.aOWPermvh7Yd8wCQ.nnjeQ2rvw5f4zkRopgXnbNG1U.hGb1hRBDYtTGm50c7kSwDe1SJtPQncpgpL6yJCjrDrpFZGoNgr9lP30iN98w7UuBFFLvvTC_15Z5dCd04ojX8Z1SNh8rCJfZtGqRtOz2YRDgmhPsn0PseGPEjzpUQq.VuzixcmNXgvQALaFTu4kh2dEFTzteQVP60XYEKwuyoTUc7OTvnEvjjnAk4VBoSCYoY3NOst8TIGNOWR4UMQ8IVEwdtE.6iXz2Znghg923opctCX1ppd2s9bTs99EkO.L6WZ_kj6ryXVoKWKE6ABvY2XO0Jp0BAXNy5p.daVexizvOdbgbraqJjBgW4dyx7eG38doBFxn3H6k83Yyp2y71RUDGr5yR0hJcXuSEGMjnSkkjKK3fi_EvYemDSZjYM7WwA1YdXon1dKn6B91j7KXDyuhpzrsJ27iRWSRQGN9tc7730QyJ4ajDPLYlnily2FVamERj4Yfm71g8JlSXGO0mJOZkQoZ_jm9ft7a_g7B9Hi5HDnDAftvUO0YOwBInPlmDffZJLbRUcErccLPNYgU3kB07UJjlaKzLI0S94YH1GdP6wxCkl0OCiS6kfO.t_ziGKeto9TjyvTKxz9Ak3kNYhvzwnP0a3P9O2oTWVRvC5EXHJGIc_cqSC3CuyCTRgz2Cs0tuaQET7KCgpHjNvv.vo6Zthky7dpzE4xpirOUU9snVmxjIPsG4HTxOLxTwX5_T3EYd227dt22sdKNJRJrgpyxHYUY2sDCFwQ1Oih_jQdLFmxtb1VMW174IERtR8GJ39qKY7J5Nu0zAJeZHnlCCXvaPJFcrlJJ5F85pepNjUPqKjeh9uDwgRdCc27fzdxvrXUrVAvNwMEiIsmEzWYpllE4phEZA.YDHWYTEiPXZ5ebKax2hLjnAKO7WTmat.EMZiNTf3nPiPZejWFE4mlgCyb8j5AOyYXyDZmnI85iwAO_h4VnyfOBEtpwx.SiY8H7C.0uHoBXs5Bgos1y991TbRrMQ6xyFBX_mz72BE2jGitt0lBqEK8qol0yckHIjGQG0n2nBFma7jfHjXMCHxXHn7Jelv7ekbpo_xVH.HFHk7YsFmEbWQqV7XotOWWIky5Fl9UWE9vIeECN2wWJNZUrSwraNlNvSnNTUaNxmXLXi.d3ZnSqExANa3DY9qaezQrM2i6Wg2MbfDE7ChfwnErMeOl9VZQh36c1ThWTIioooSa8CCWMS49K5XbGbqtDP6pY_OaQp8gTQtSkMh3Fv8Vwyq6XmW0LdGuj9Q2qdzFvdzdsqTjSK7P5QVwa8ujq8BcqnUKArrEbFwdOUPftJbvsMaUITQnAVgTxxfMNy6sgN9GSYuzzmSzZ7uJM7mGGETuw0PMd3TU9ywn3wTmeqKRahZwIQxB2OaPRCYGo_ZD1t8bonEWwbUCAkQXkOsttgMKFWJcgBzgh_9T_OQbAj1ndOYMz7wQcnjlsvi9gz0qKxnYCf1FAhg2BDeGGqARYL.2Mbw12ul5sLlUVzmgYtWmZsz_gAzqyJbcj5dxBh7RWJV9yVkB6HNwpRlM63sQNV7pMQtGxr9mUeNlov.s9JzEJCBX2PC8k5w2DmUQI0CT3pIFBdFMBj1yP.QInBPC08s.zZgURYHgHDd4xmNZXGQF990KY.bn0xuWguL81CydWkNnuFiWO8IAV23g6ZL83cJcKNTGQZ2cGeHE0fQ1rGW_KA_SkLV9siN9oKW.F14FW5fzbGq5ZStAU0ue7L2kW.hd2a_EVWbLU5mSwUy7nWIyVymDA',};var a = document.createElement('script');a.src = '/cdn-cgi/challenge-platform/h/g/orchestrate/chl_page/v1?ray=9bc4ed8f4e07c410';window._cf_chl_opt.cOgUHash = location.hash === '' && location.href.indexOf('#') !== -1 ? '#' : location.hash;window._cf_chl_opt.cOgUQuery = location.search === '' && location.href.slice(0, location.href.length - window._cf_chl_opt.cOgUHash.length).indexOf('?') !== -1 ? '?' : location.search;if (window.history && window.history.replaceState) {var ogU = location.pathname + window._cf_chl_opt.cOgUQuery + window._cf_chl_opt.cOgUHash;history.replaceState(null, null,"\/9780141439808?__cf_chl_rt_tk=_LY3Mgvpzv9UZHQNvAOWrCLe6JnE0Xn9_HEIfxyZdRg-1768139896-1.0.1.1-gOR5PQaITjvin.z07Qv9vJwxeVGRWdmuEhPAQgjV1Xg"+ window._cf_chl_opt.cOgUHash);a.onload = function() {history.replaceState(null, null, ogU);}}document.getElementsByTagName('head')[0].appendChild(a);}());</script></body></html>

====================
FILE: enrich_openlibrary.py
====================
#!/usr/bin/env python3

import time
import requests
import psycopg2
from datetime import datetime

# =========================
# CONFIG
# =========================

DB_CONFIG = {
    "dbname": "eob_catalog",
    "user": "eob_owner",
    "password": "!!!itff2025@@@",
    "host": "localhost",
}

OPENLIB_TIMEOUT = 15
BATCH_SIZE = 50
SLEEP_BETWEEN_BOOKS = 0.7


# =========================
# OPEN LIBRARY FETCH
# =========================

def fetch_openlibrary(isbn13):
    url = "https://openlibrary.org/api/books"
    params = {
        "bibkeys": f"ISBN:{isbn13}",
        "format": "json",
        "jscmd": "data",
    }

    try:
        r = requests.get(url, params=params, timeout=OPENLIB_TIMEOUT)
        r.raise_for_status()

        # OL sometimes returns HTML or empty body
        if not r.text.strip().startswith("{"):
            return None

        raw = r.json().get(f"ISBN:{isbn13}")
        if not raw:
            return None

        # ---- Normalize fields ----

        title = raw.get("title")

        authors = ", ".join(
            a.get("name") for a in raw.get("authors", []) if a.get("name")
        ) or None

        publishers = ", ".join(
            p.get("name") for p in raw.get("publishers", []) if p.get("name")
        ) or None

        publish_date = raw.get("publish_date")
        publish_year = None
        if publish_date:
            digits = "".join(c for c in publish_date if c.isdigit())
            if len(digits) >= 4:
                publish_year = int(digits[:4])

        pages = raw.get("number_of_pages")

        subjects = [
            s.get("name") for s in raw.get("subjects", []) if s.get("name")
        ] or None

        language = None
        if raw.get("languages"):
            language = raw["languages"][0].get("key", "").split("/")[-1]

        description = raw.get("description")
        if isinstance(description, dict):
            description = description.get("value")

        cover_url = None
        if raw.get("cover"):
            cover_url = raw["cover"].get("large") or raw["cover"].get("medium")

        return {
            "isbn13": isbn13,
            "title": title,
            "author": authors,
            "publisher": publishers,
            "publish_year": publish_year,
            "publish_date": publish_date,
            "pages": pages,
            "subjects": subjects,
            "language": language,
            "description": description,
            "cover_url": cover_url,
        }

    except Exception:
        return None


# =========================
# MAIN ENRICHMENT LOOP
# =========================

def main():
    conn = psycopg2.connect(**DB_CONFIG)
    cur = conn.cursor()

    cur.execute("""
        SELECT isbn13
        FROM book_metadata
        WHERE last_enriched IS NULL
        ORDER BY isbn13
        LIMIT %s;

    """, (BATCH_SIZE,))

    rows = cur.fetchall()
    if not rows:
        print("No books to enrich.")
        return

    print(f"Enriching {len(rows)} ISBNs")

    for (isbn13,) in rows:
        print(f"‚Üí {isbn13}")

        data = fetch_openlibrary(isbn13)

        # --------------------------------------------------
        # BAD / EMPTY RESPONSE ‚Üí MARK ATTEMPTED, SKIP
        # --------------------------------------------------
        if not data:
            cur.execute("""
                UPDATE book_metadata
                SET last_enriched = %(now)s,
                    source = 'openlibrary'
                WHERE isbn13 = %(isbn13)s
            """, {
                "isbn13": isbn13,
                "now": datetime.utcnow()
            })
            conn.commit()
            time.sleep(0.3)
            continue

        # --------------------------------------------------
        # UPSERT CLEAN DATA
        # --------------------------------------------------
        cur.execute("""
            INSERT INTO book_metadata (
                isbn13,
                title,
                author,
                publisher,
                publish_year,
                publish_date,
                pages,
                subjects,
                language,
                description,
                cover_url,
                last_enriched,
                source
            )
            VALUES (
                %(isbn13)s,
                %(title)s,
                %(author)s,
                %(publisher)s,
                %(publish_year)s,
                %(publish_date)s,
                %(pages)s,
                %(subjects)s,
                %(language)s,
                %(description)s,
                %(cover_url)s,
                %(now)s,
                'openlibrary'
            )
            ON CONFLICT (isbn13) DO UPDATE SET
                title = COALESCE(EXCLUDED.title, book_metadata.title),
                author = COALESCE(EXCLUDED.author, book_metadata.author),
                publisher = COALESCE(EXCLUDED.publisher, book_metadata.publisher),
                publish_year = COALESCE(EXCLUDED.publish_year, book_metadata.publish_year),
                publish_date = COALESCE(EXCLUDED.publish_date, book_metadata.publish_date),
                pages = COALESCE(EXCLUDED.pages, book_metadata.pages),
                subjects = COALESCE(EXCLUDED.subjects, book_metadata.subjects),
                language = COALESCE(EXCLUDED.language, book_metadata.language),
                description = COALESCE(EXCLUDED.description, book_metadata.description),
                cover_url = COALESCE(EXCLUDED.cover_url, book_metadata.cover_url),
                last_enriched = EXCLUDED.last_enriched,
                source = 'openlibrary'
        """, {
            **data,
            "now": datetime.utcnow()
        })

        conn.commit()
        time.sleep(SLEEP_BETWEEN_BOOKS)

    cur.close()
    conn.close()


if __name__ == "__main__":
    main()



====================
FILE: manage.py
====================
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings_dev')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()


====================
FILE: scrape_OL_LoC_Biblio_Alibris.py
====================
import requests

ISBN = "9780141439808"

HEADERS = {
    "User-Agent": (
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
        "AppleWebKit/537.36 (KHTML, like Gecko) "
        "Chrome/120.0.0.0 Safari/537.36"
    ),
    "Accept-Language": "en-US,en;q=0.9",
}

url = f"https://www.biblio.com/{ISBN}"

r = requests.get(url, headers=HEADERS, timeout=20)

print("STATUS:", r.status_code)
print("FINAL URL:", r.url)
print("HEADERS RETURNED:")
for k, v in r.headers.items():
    print(f"  {k}: {v}")

print("\n--- FIRST 1000 CHARS OF HTML ---\n")
print(r.text[:1000])

# Save full HTML to disk
filename = f"biblio_raw_{ISBN}.html"
with open(filename, "w", encoding="utf-8") as f:
    f.write(r.text)

print(f"\nFull HTML saved to {filename}")


====================
FILE: test_loc_isbn.py
====================
import requests
import time

# =========================
# CONFIG
# =========================

ISBN_LIST = [
    "0068596022",
    "1335009833",
    "0060950196",
    "0385494122",
    "0050014234",
    "0736908552",
]

LOC_SRU = "https://lccn.loc.gov/sru"

HEADERS = {
    "User-Agent": "EducatedOwlBooks/1.0 (LoC BIBFRAME/MODS SRU)"
}

TIMEOUT = 30
SLEEP = 1

# =========================
# SRU QUERY
# =========================

def fetch_loc_mods_by_isbn(isbn: str) -> str:
    params = {
        "version": "1.1",
        "operation": "searchRetrieve",
        "query": f"bath.isbn={isbn}",
        "recordSchema": "mods",
        "maximumRecords": 1,
    }

    r = requests.get(
        LOC_SRU,
        params=params,
        headers=HEADERS,
        timeout=TIMEOUT,
    )
    r.raise_for_status()
    return r.text


# =========================
# MAIN
# =========================

def main():
    for isbn in ISBN_LIST:
        print("=" * 100)
        print(f"ISBN: {isbn}")

        try:
            xml = fetch_loc_mods_by_isbn(isbn)
        except Exception as e:
            print(f"ERROR querying LoC SRU: {e}")
            continue

        if "<mods:mods" not in xml:
            print("‚ùå No MODS record found")
            continue

        print("‚úÖ MODS record retrieved (preview)\n")
        print(xml[:3000])
        time.sleep(SLEEP)


if __name__ == "__main__":
    main()


====================
FILE: accounts\admin.py
====================
from django.contrib import admin
from .models import Seller


@admin.register(Seller)
class SellerAdmin(admin.ModelAdmin):
    list_display = ("display_name", "user", "country")


====================
FILE: accounts\apps.py
====================
from django.apps import AppConfig


class AccountsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'accounts'


====================
FILE: accounts\models.py
====================
from django.conf import settings
from django.db import models


class Seller(models.Model):
    user = models.OneToOneField(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="seller_profile",
    )

    display_name = models.CharField(max_length=255)
    country = models.CharField(max_length=64, blank=True)

    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.display_name


====================
FILE: accounts\tests.py
====================
from django.test import TestCase

# Create your tests here.


====================
FILE: accounts\urls.py
====================


====================
FILE: accounts\views.py
====================
from django.shortcuts import render

# Create your views here.


====================
FILE: accounts\__init__.py
====================


====================
FILE: catalog\admin.py
====================
from django.contrib import admin
from .models import Book

@admin.register(Book)
class BookAdmin(admin.ModelAdmin):
    list_display = ('title', 'author', 'isbn10', 'rating_avg', 'pages')
    search_fields = ('title', 'author', 'isbn10')
    list_filter = ('language', 'format')
    

====================
FILE: catalog\apps.py
====================
from django.apps import AppConfig


class CatalogConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'catalog'


====================
FILE: catalog\models.py
====================
import os
from django.db import models

# NOTE:
# Cover storage paths intentionally prefer ISBN-10 when available.
# This mirrors the primary enrichment identifier choice.

def get_catalog_upload_path(instance, filename):
    """
    Generates a partitioned path for book covers.
    Example: ISBN 0123456789 -> catalog/covers/0/1/2/0123456789.jpg
    """
    isbn = instance.isbn10 or instance.isbn13 or "unknown"
    return os.path.join('catalog', 'covers', *isbn[:3], filename)

class Category(models.Model):
    name = models.CharField(max_length=100, unique=True)
    slug = models.SlugField(unique=True)
    description = models.TextField(blank=True)
    order = models.PositiveIntegerField(default=0)

    class Meta:
        ordering = ["order", "name"]

    def __str__(self):
        return self.name


class Book(models.Model):

    # ============================================================
    # IDENTIFIERS ‚Äî READ THIS BEFORE CHANGING
    # ============================================================
    #
    # ‚ö†Ô∏è DESIGN DECISION (INTENTIONAL):
    #
    # ISBN-10 is treated as the PRIMARY enrichment identifier
    # when available.
    #
    # Rationale:
    # - Used / legacy book markets still heavily rely on ISBN-10
    # - Many seller feeds and historical datasets provide ISBN-10 only
    # - Amazon ASIN mappings and older catalog data align more reliably
    #   with ISBN-10 than ISBN-13
    #
    # ISBN-13 is fully supported and stored, but ISBN-10 remains the
    # enrichment anchor by design.
    #
    # DO NOT casually refactor this to ‚ÄúISBN-13 only‚Äù without reviewing:
    # - ingestion pipelines
    # - seller feeds
    # - listings URLs
    # - search indexing
    #
    # See also: catalog/management/commands/import_books.py
    # ============================================================

    isbn10 = models.CharField(
        max_length=10,
        unique=True,
        null=True,
        blank=True,
        db_index=True,
        help_text="Primary enrichment identifier when available (by design)",
    )

    isbn13 = models.CharField(
        max_length=13,
        unique=True,
        null=True,
        blank=True,
        db_index=True,
        help_text="Secondary identifier; always stored when available",
    )
    categories = models.ManyToManyField(
        Category,
        related_name="books",
        blank=True,
    )
    amazon_asin = models.CharField(
        max_length=20, blank=True, null=True, help_text="Amazon Standard Identification Number"
    )

    last_enriched = models.DateTimeField(null=True, blank=True)

    # Core Metadata
    title = models.CharField(max_length=512)
    author = models.CharField(max_length=512, blank=True)
    publisher = models.CharField(max_length=255, blank=True)
    publication_year = models.PositiveSmallIntegerField(null=True, blank=True)
    
    # Rich Content
    description = models.TextField(blank=True, null=True)
    language = models.CharField(max_length=32, blank=True)
    pages = models.PositiveIntegerField(null=True, blank=True)
    format = models.CharField(
        max_length=64, blank=True, help_text="Hardcover, Paperback, etc.",
    )

    # Social & Stats
    rating_avg = models.FloatField(null=True, blank=True)
    want_to_read_count = models.IntegerField(default=0)
    currently_reading_count = models.IntegerField(default=0)
    already_read_count = models.IntegerField(default=0)
    preview_url = models.URLField(blank=True, null=True)

    # Media
    cover_image = models.ImageField(
        upload_to=get_catalog_upload_path,
        blank=True, null=True,
        help_text="Cover image of the book",
    )
    cover_openlibrary_id = models.CharField(max_length=32, null=True, blank=True)

    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ["title"]
        indexes = [
            models.Index(fields=["title"]),
            models.Index(fields=["author"]),
        ]

    def __str__(self):
        return f"{self.title} ({self.author})" if self.author else self.title

====================
FILE: catalog\tests.py
====================
from django.test import TestCase

# Create your tests here.


====================
FILE: catalog\urls.py
====================
# catalog/urls.py
from django.urls import path
from .views import book_detail

urlpatterns = [
    path("<str:identifier>/", book_detail, name="book_detail"),
]

====================
FILE: catalog\views.py
====================
# catalog/views.py
from django.shortcuts import get_object_or_404, render
from django.db.models import Q
from .models import Book

def book_detail(request, identifier):
    book = get_object_or_404(
        Book,
        Q(isbn10=identifier) | Q(isbn13=identifier)
    )

    listings_qs = (
        book.listings
        .select_related("seller")
        .filter(quantity__gt=0)
        .order_by("price")
    )

    primary_listing = listings_qs.first()
    other_listings = listings_qs[1:]

    return render(
        request,
        "book_detail.html",
        {
            "book": book,
            "primary_listing": primary_listing,
            "other_listings": other_listings,
        }
    )


====================
FILE: catalog\__init__.py
====================


====================
FILE: catalog\management\__init__.py
====================


====================
FILE: catalog\management\commands\import_books.py
====================
import csv
import time
import requests

from django.core.management.base import BaseCommand
from django.core.files.base import ContentFile
from django.utils import timezone

from catalog.models import Book


class Command(BaseCommand):
    help = "Import rich book data (Ratings, Social, Descriptions, ASIN) from Open Library"

    def add_arguments(self, parser):
        parser.add_argument("csv_file", type=str)
        parser.add_argument("--sleep", type=float, default=2.0)

    def handle(self, *args, **options):
        csv_file = options["csv_file"]
        sleep_time = options["sleep"]

        with open(csv_file, newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for row in reader:
                isbn = row.get("isbn10", "").strip()
                if not isbn:
                    continue

                self.stdout.write(f"Processing ISBN: {isbn}...")
                self.import_rich_book(isbn)

                time.sleep(sleep_time)  # respectful throttling

    def import_rich_book(self, isbn):
        """
        Enrich a single book from Open Library.
        last_enriched is only set if ALL steps succeed.
        """
        try:
            # --------------------------------------------------
            # 1. Fetch core metadata (Books API)
            # --------------------------------------------------
            url = (
                f"https://openlibrary.org/api/books"
                f"?bibkeys=ISBN:{isbn}&format=json&jscmd=data"
            )

            data_resp = requests.get(url, timeout=15).json().get(f"ISBN:{isbn}", {})
            if not data_resp:
                self.stderr.write(f"No data found for {isbn}")
                return

            # --------------------------------------------------
            # 2. Fetch social stats (Search API)
            # --------------------------------------------------
            search_url = (
                "https://openlibrary.org/search.json"
                f"?q=isbn:{isbn}"
                "&fields=key,want_to_read_count,already_read_count,"
                "currently_reading_count,ratings_average"
            )

            search_resp = requests.get(search_url, timeout=15).json()
            search_doc = (
                search_resp.get("docs", [{}])[0]
                if search_resp.get("docs")
                else {}
            )

            # --------------------------------------------------
            # 3. Fetch description (Works API)
            # --------------------------------------------------
            description = ""
            work_key = search_doc.get("key")  # /works/OLxxxxW
            if work_key:
                work_data = requests.get(
                    f"https://openlibrary.org{work_key}.json",
                    timeout=15,
                ).json()

                raw_desc = work_data.get("description", "")
                if isinstance(raw_desc, dict):
                    description = raw_desc.get("value", "")
                else:
                    description = raw_desc or ""

            # --------------------------------------------------
            # 4. Extract normalized fields
            # --------------------------------------------------
            title = data_resp.get("title", "Unknown")

            author_names = ", ".join(
                a.get("name") for a in data_resp.get("authors", []) if a.get("name")
            )

            publisher = data_resp.get("publishers", [{}])[0].get("name", "")

            pub_year = None
            if "publish_date" in data_resp:
                digits = "".join(c for c in data_resp["publish_date"] if c.isdigit())
                if len(digits) >= 4:
                    pub_year = int(digits[:4])

            # --------------------------------------------------
            # 5. Upsert book (idempotent, cron-safe)
            # --------------------------------------------------
            book, created = Book.objects.update_or_create(
                isbn10=isbn,
                defaults={
                    "title": title,
                    "author": author_names,
                    "publisher": publisher,
                    "publication_year": pub_year,
                    "description": description,
                    "language": data_resp.get("languages", [{}])[0].get("name", ""),
                    "pages": data_resp.get("number_of_pages"),
                    "amazon_asin": data_resp.get("identifiers", {}).get("amazon", [None])[0],
                    "rating_avg": search_doc.get("ratings_average"),
                    "want_to_read_count": search_doc.get("want_to_read_count", 0),
                    "currently_reading_count": search_doc.get("currently_reading_count", 0),
                    "already_read_count": search_doc.get("already_read_count", 0),
                    "preview_url": data_resp.get("preview_url", ""),
                },
            )

            # --------------------------------------------------
            # 6. Handle cover image (optional)
            # --------------------------------------------------
            cover_data = data_resp.get("cover", {})
            cover_url = cover_data.get("large") or cover_data.get("medium")
            if cover_url:
                self.download_cover(book, cover_url)

            # --------------------------------------------------
            # 7. Mark successful enrichment (THIS is the key line)
            # --------------------------------------------------
            book.last_enriched = timezone.now()
            book.save(update_fields=["last_enriched"])

            self.stdout.write(
                self.style.SUCCESS(f"Successfully enriched {title}")
            )

        except Exception as e:
            self.stderr.write(f"Failed {isbn}: {str(e)}")

    def download_cover(self, book, url):
        try:
            r = requests.get(url, timeout=10)
            if r.status_code == 200:
                book.cover_image.save(
                    f"{book.isbn10}.jpg",
                    ContentFile(r.content),
                    save=True,
                )
        except Exception:
            pass


====================
FILE: catalog\management\commands\import_dev_sample.py
====================
import csv
from django.core.management.base import BaseCommand
from django.utils.dateparse import parse_datetime
from catalog.models import Book


class Command(BaseCommand):
    help = "Import enriched sample books into DEV database"

    def add_arguments(self, parser):
        parser.add_argument("csv_file", type=str)

    def handle(self, *args, **options):
        path = options["csv_file"]

        with open(path, newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)

            for row in reader:
                Book.objects.update_or_create(
                    isbn13=row["isbn13"],
                    defaults={
                        "title": row["title"],
                        "author": row["author"],
                        "publisher": row["publisher"],
                        "publication_year": row["publication_year"] or None,
                        "description": row["description"],
                        "last_enriched": parse_datetime(row["last_enriched"]),
                    },
                )

        self.stdout.write(self.style.SUCCESS("DEV sample import complete"))


====================
FILE: catalog\management\commands\scrape_amazon_best.py
====================
import csv
import random
import re
import time
import os
from dataclasses import dataclass
from typing import List, Dict

from bs4 import BeautifulSoup
from curl_cffi import requests


# =========================
# CONFIG
# =========================

SUBCATEGORIES = [
    "https://www.amazon.com/Best-Sellers-Books-Romance/zgbs/books/23",

]

MAX_ITEMS_PER_PAGE = 30

# Amazon needs BIG delays
AMAZON_SLEEP_MIN = 300     # 5 minutes
AMAZON_SLEEP_MAX = 900     # 15 minutes

OPENLIB_SLEEP_MIN = 1
OPENLIB_SLEEP_MAX = 3

OUTPUT_FILE = "amazon_seed_books.csv"


# =========================
# REGEX / STRUCTURES
# =========================

ASIN_RE = re.compile(r"/dp/([A-Z0-9]{10})")


@dataclass
class AmazonItem:
    rank: int
    asin: str
    title: str
    author: str
    url: str


# =========================
# UTILITIES
# =========================

def sleep_range(a, b, label=""):
    t = random.uniform(a, b)
    print(f"Sleeping {t:.1f}s {label}")
    time.sleep(t)


def amazon_session():
    s = requests.Session(impersonate="chrome120")
    s.headers.update({
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
        "Accept-Language": "en-US,en;q=0.9",
        "Upgrade-Insecure-Requests": "1",
        "Referer": "https://www.amazon.com/",
        "DNT": "1",
    })
    return s


def ensure_csv_header(path: str, fieldnames: List[str]):
    if not os.path.exists(path):
        with open(path, "w", newline="", encoding="utf-8") as f:
            writer = csv.DictWriter(f, fieldnames=fieldnames)
            writer.writeheader()


def append_rows(path: str, rows: List[Dict]):
    if not rows:
        return
    with open(path, "a", newline="", encoding="utf-8") as f:
        writer = csv.DictWriter(f, fieldnames=rows[0].keys())
        writer.writerows(rows)


# =========================
# AMAZON
# =========================

def fetch_html(session, url):
    r = session.get(url, timeout=20)
    html = r.text or ""

    if r.status_code in (429, 503):
        raise RuntimeError("Amazon rate-limited")
    if "captcha" in html.lower():
        raise RuntimeError("Amazon CAPTCHA detected")

    return html


def parse_items(html: str) -> List[AmazonItem]:
    soup = BeautifulSoup(html, "lxml")
    items = []

    blocks = soup.select("div.zg-grid-general-faceout")
    for i, block in enumerate(blocks, start=1):
        link = block.find("a", href=re.compile(r"/dp/"))
        if not link:
            continue

        href = link.get("href", "")
        m = ASIN_RE.search(href)
        if not m:
            continue

        asin = m.group(1)
        url = "https://www.amazon.com" + href.split("?")[0]

        title = ""
        img = block.find("img")
        if img and img.get("alt"):
            title = img["alt"].strip()

        author = ""
        for s in block.select("a.a-size-small, span.a-size-small"):
            t = s.get_text(strip=True)
            if t and not any(k in t.lower() for k in ["paperback", "hardcover", "kindle"]):
                author = t
                break

        if title and author:
            items.append(AmazonItem(i, asin, title, author, url))

        if len(items) >= MAX_ITEMS_PER_PAGE:
            break

    return items


# =========================
# OPEN LIBRARY (AUTHORITATIVE)
# =========================

def openlibrary_lookup(title, author):
    q = f"{title} {author}".strip()

    r = requests.get(
        "https://openlibrary.org/search.json",
        params={
            "q": q,
            "fields": "key,title,author_name,isbn",
            "limit": 5,
        },
        timeout=15,
    )

    if r.status_code != 200:
        return None

    for d in r.json().get("docs", []):
        isbns = d.get("isbn") or []
        isbn10 = next((x for x in isbns if len(x) == 10), "")
        isbn13 = next((x for x in isbns if len(x) == 13), "")

        if isbn10 or isbn13:
            return {
                "isbn10": isbn10,
                "isbn13": isbn13,
                "ol_key": d.get("key", ""),
            }

    return None


# =========================
# MAIN
# =========================

def main():
    # Pick ONE category per run
    subcat = random.choice(SUBCATEGORIES)
    print(f"Selected subcategory: {subcat}")

    session = amazon_session()

    fieldnames = [
        "rank",
        "amazon_asin",
        "amazon_title",
        "amazon_author",
        "amazon_url",
        "isbn10",
        "isbn13",
        "ol_key",
        "subcategory_url",
    ]

    ensure_csv_header(OUTPUT_FILE, fieldnames)

    try:
        html = fetch_html(session, subcat)
    except RuntimeError as e:
        print(f"Stopping run due to Amazon block: {e}")
        return

    items = parse_items(html)
    print(f"Parsed {len(items)} Amazon items")

    seen = set()
    rows = []

    for it in items:
        sleep_range(OPENLIB_SLEEP_MIN, OPENLIB_SLEEP_MAX, "(Open Library)")

        ol = openlibrary_lookup(it.title, it.author)
        if not ol:
            continue

        dedupe_key = ol.get("isbn10") or ol.get("isbn13") or ol.get("ol_key")
        if dedupe_key in seen:
            continue
        seen.add(dedupe_key)

        rows.append({
            "rank": it.rank,
            "amazon_asin": it.asin,
            "amazon_title": it.title,
            "amazon_author": it.author,
            "amazon_url": it.url,
            "isbn10": ol.get("isbn10", ""),
            "isbn13": ol.get("isbn13", ""),
            "ol_key": ol.get("ol_key", ""),
            "subcategory_url": subcat,
        })

    append_rows(OUTPUT_FILE, rows)
    print(f"Saved {len(rows)} rows")

    print("\nRun complete (single Amazon page).")


if __name__ == "__main__":
    main()


====================
FILE: catalog\management\commands\__init__.py
====================


====================
FILE: catalog\templates\book_detail.html
====================
{% extends "main/base.html" %}
{% load static %}

{% block title %}{{ book.title }} | Educated Owl Books{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/book_detail.css' %}">

<div class="book-container">

    <!-- LEFT COLUMN: BOOK INFO -->
    <div class="book-info">

        <h1 class="book-title">{{ book.title }}</h1>
        <p class="book-author">by <strong>{{ book.author }}</strong></p>

        <div class="book-meta-stats">
            <span class="stat-badge">‚≠ê {{ book.rating_avg|default:"‚Äî" }}</span>
            <span class="stat-badge">üìñ {{ book.want_to_read_count }} Want to Read</span>
            <span class="stat-badge">‚úÖ {{ book.already_read_count }} Read</span>
        </div>

        {% if book.cover_image %}
            <img
                src="{{ book.cover_image.url }}"
                alt="{{ book.title }}"
                style="max-width:180px; margin: 1rem 0;"
            >
        {% endif %}

        <section class="book-description">
            <h2>Description</h2>
            <p>{{ book.description|default:"No description available." }}</p>
        </section>

        <table class="meta-table">
            <tr><th>ISBN-10</th><td>{{ book.isbn10 }}</td></tr>
            <tr><th>ISBN-13</th><td>{{ book.isbn13 }}</td></tr>
            <tr><th>Publisher</th><td>{{ book.publisher }} ({{ book.publication_year }})</td></tr>
            <tr><th>Pages</th><td>{{ book.pages|default:"‚Äî" }}</td></tr>
            <tr><th>Language</th><td>{{ book.language }}</td></tr>
        </table>

    </div>

    <!-- RIGHT COLUMN: PRIMARY OFFER -->
    <aside class="primary-offer">

        {% if primary_listing %}
        <div class="primary-price-title">  
            Lowest-Priced Available Copy 
        </div>

            <div class="primary-price">
                ${{ primary_listing.price }}
            </div>

            <div class="primary-meta">
                <strong>{{ primary_listing.get_condition_display }}</strong><br>
                {% if primary_listing.format %}
                    {{ primary_listing.get_format_display }}<br>
                {% endif %}
                Sold by {{ primary_listing.seller.display_name }}
                {% if primary_listing.seller.country %}
                    <br><span class="seller-country">
                        Ships from {{ primary_listing.seller.country }}
                    </span>
                {% endif %}
                <p class="seller-policy-note">
                    Orders are fulfilled directly by the seller.  
                    Returns and refunds follow the seller‚Äôs stated policy.
                </p>

            </div>

            <div class="primary-stock">
                {% if primary_listing.quantity > 1 %}
                    {{ primary_listing.quantity }} available
                {% else %}
                    In stock
                {% endif %}
            </div>

            <button class="btn-primary" disabled>
                Add to cart
            </button>
        {% else %}
            <p>No copies currently available.</p>
        {% endif %}

    </aside>

</div>

<!-- OTHER SELLERS -->
{% if other_listings %}
<section class="other-offers">

    <h2>Other Sellers Offering This Book</h2>

    <table class="copies-table">
        <thead>
            <tr>
                <th>Seller</th>
                <th>Format</th>
                <th>Condition</th>
                <th class="price-col">Price</th>
            </tr>
        </thead>
        <tbody>
        {% for listing in other_listings %}
            <tr>
                <td>{{ listing.seller.display_name }}</td>
                <td>{{ listing.get_format_display|default:"‚Äî" }}</td>
                <td>{{ listing.get_condition_display }}</td>
                <td>${{ listing.price }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

</section>
{% endif %}

{% endblock %}


====================
FILE: config\asgi.py
====================
"""
ASGI config for config project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_asgi_application()


====================
FILE: config\settings_base.py
====================
from pathlib import Path
import os

BASE_DIR = Path(__file__).resolve().parent.parent


# Application definition
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'main',
    'accounts',
    'catalog',
    'listings',
    'orders',
    'search',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'UTC'
USE_I18N = True
USE_TZ = True

MEDIA_URL = "/media/"
MEDIA_ROOT = BASE_DIR / "media"

STATIC_URL = '/static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'


====================
FILE: config\settings_dev.py
====================
from .settings_base import *

DEBUG = True
SECRET_KEY = "m4@jabq^2q$ch!k4mdn%j20)tncs68dbf55!!dp3oe#9ha=%bn"
ALLOWED_HOSTS = ["127.0.0.1", "localhost"]


====================
FILE: config\settings_prod.py
====================
from .settings_base import *
import os

SECRET_KEY = os.environ["SECRET_KEY"]

DEBUG = False

ALLOWED_HOSTS = [
    "educatedowlbooks.com",
    "www.educatedowlbooks.com",
]

CSRF_TRUSTED_ORIGINS = [
    "https://educatedowlbooks.com",
    "https://www.educatedowlbooks.com",
]

DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.postgresql",
        "NAME": "educatedowlbooks",
        "USER": "eob_user",
        "PASSWORD": os.environ.get("DB_PASSWORD"),
        "HOST": "localhost",
        "PORT": "5432",
    }
}

SECURE_PROXY_SSL_HEADER = ("HTTP_X_FORWARDED_PROTO", "https")

SECURE_SSL_REDIRECT = True

SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True

SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True

SECURE_HSTS_SECONDS = 31536000  # 1 year
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True


====================
FILE: config\urls.py
====================
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path("secure-admin-9xQp/", admin.site.urls),
    path("", include("main.urls")),
    path("books/", include("listings.urls")),
    path("catalog/", include("catalog.urls")),

]

if settings.DEBUG:
    urlpatterns += static(
        settings.MEDIA_URL,
        document_root=settings.MEDIA_ROOT
    )

====================
FILE: config\wsgi.py
====================
import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings_prod')

application = get_wsgi_application()


====================
FILE: config\__init__.py
====================


====================
FILE: listings\admin.py
====================
from django.contrib import admin
from .models import Listing


@admin.register(Listing)
class ListingAdmin(admin.ModelAdmin):
    list_display = (
        "book",
        "seller",
        "price",
        "condition",
        "quantity",
    )
    list_filter = ("condition", "seller")
    search_fields = ("book__title", "book__author", "seller__display_name")


====================
FILE: listings\apps.py
====================
from django.apps import AppConfig


class ListingsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'listings'


====================
FILE: listings\models.py
====================
from django.db import models
from catalog.models import Book
from accounts.models import Seller


class Listing(models.Model):
    CONDITION_CHOICES = [
        ("new", "New"),
        ("like_new", "Like New"),
        ("very_good", "Very Good"),
        ("good", "Good"),
        ("acceptable", "Acceptable"),
    ]

    FORMAT_CHOICES = [
    ("paperback", "Paperback"),
    ("hardcover", "Hardcover"),
    ("mass_market", "Mass Market Paperback"),
    ]

    seller = models.ForeignKey(
        Seller,
        on_delete=models.CASCADE,
        related_name="listings",
    )

    book = models.ForeignKey(
        Book,
        on_delete=models.CASCADE,
        related_name="listings",
    )

    price = models.DecimalField(
        max_digits=10,
        decimal_places=2,
    )

    format = models.CharField(
        max_length=32,
        choices=FORMAT_CHOICES,
        blank=True,
    )

    condition = models.CharField(
        max_length=20,
        choices=CONDITION_CHOICES,
    )

    quantity = models.PositiveIntegerField(default=1)

    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ["price"]
        indexes = [
            models.Index(fields=["price"]),
            models.Index(fields=["condition"]),
        ]

    def __str__(self):
        return f"{self.book.title} ‚Äî {self.seller.display_name}"


====================
FILE: listings\tests.py
====================
from django.test import TestCase

# Create your tests here.


====================
FILE: listings\urls.py
====================
from django.urls import path
from .views import public_listings
from . import views


urlpatterns = [
    path("", public_listings, name="public_listings"),
]


====================
FILE: listings\views.py
====================
from django.db.models import Q
from django.shortcuts import render
from .models import Listing


def public_listings(request):
    query = request.GET.get("q", "")
    format_filter = request.GET.get("format")
    language_filter = request.GET.get("language")
    era = request.GET.get("era")
    special = request.GET.get("special")

    listings = Listing.objects.select_related("book", "seller")

    if query:
        listings = listings.filter(
            Q(book__title__icontains=query)
            | Q(book__author__icontains=query)
            | Q(book__isbn10__icontains=query)
            | Q(book__isbn13__icontains=query)
        )

    if format_filter:
        listings = listings.filter(book__format=format_filter)

    if language_filter:
        listings = listings.filter(book__language=language_filter)

    if era == "classics":
        listings = listings.filter(book__publication_year__lte=1970)
    elif era == "modern":
        listings = listings.filter(
            book__publication_year__gt=1970,
            book__publication_year__lte=2000,
        )
    elif era == "contemporary":
        listings = listings.filter(book__publication_year__gt=2000)

    if special == "highly-rated":
        listings = listings.filter(book__rating_avg__gte=4.0)
    elif special == "most-wanted":
        listings = listings.filter(book__want_to_read_count__gte=100)

    return render(
        request,
        "listings/public_listings.html",
        {
            "listings": listings,
            "query": query,
        },
    )


====================
FILE: listings\__init__.py
====================


====================
FILE: listings\templates\listings\public_listings.html
====================
{% extends "main/base.html" %}

{% block title %}Books for Sale{% endblock %}

{% block content %}

<h2>Books for Sale</h2>

<form method="get" style="margin-bottom: 1.5rem;">
    <input
        type="text"
        name="q"
        placeholder="Search by title, author, ISBN"
        value="{{ query }}"
        style="width: 300px;"
    />
    <button type="submit">Search</button>
</form>

<hr>

{% for listing in listings %}
    <div style="
        display: grid;
        grid-template-columns: 80px 1fr auto;
        gap: 15px;
        border-bottom: 1px solid #ddd;
        padding: 15px 0;
        align-items: center;
    ">

        {# Cover #}
        {% if listing.book.cover_image %}
            <a href="{% url 'book_detail' listing.book.isbn13 %}">
                <img
                    src="{{ listing.book.cover_image.url }}"
                    alt="{{ listing.book.title }}"
                    style="width: 80px; height: auto; object-fit: contain;"
                />
            </a>
        {% else %}
            <div style="
                width: 80px;
                height: 120px;
                background: #eee;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                color: #777;
            ">
                No cover
            </div>
        {% endif %}

        {# Book + listing info #}
        <div>
            <strong style="font-size: 1.05rem;">
                <a href="{% url 'book_detail' listing.book.isbn13 %}" style="text-decoration:none; color:inherit;">
                    {{ listing.book.title }}
                </a>
            </strong><br>

            <span style="color:#555;">
                {{ listing.book.author }}
            </span><br>

            {% if listing.format %}
                <span style="font-size: 0.9rem;">
                    {{ listing.get_format_display }}
                </span> ¬∑
            {% endif %}

            <span style="font-size: 0.9rem;">
                {{ listing.get_condition_display }}
            </span><br>

            <small style="color:#666;">
                Sold by {{ listing.seller.display_name }}
            </small>
        </div>

        {# Price + action #}
        <div style="text-align: right;">
            <div style="font-size: 1.2rem; font-weight: 600;">
                ${{ listing.price }}
            </div>

            <div style="font-size: 0.8rem; color:#666;">
                {% if listing.quantity > 1 %}
                    {{ listing.quantity }} available
                {% else %}
                    In stock
                {% endif %}
            </div>

            {# Placeholder for future cart button #}
            <div style="margin-top: 0.5rem;">
                <button disabled style="
                    padding: 4px 10px;
                    font-size: 0.85rem;
                    opacity: 0.6;
                ">
                    Add to cart
                </button>
            </div>
        </div>

    </div>

{% empty %}
    <p>No books found.</p>
{% endfor %}

{% endblock %}


====================
FILE: main\admin.py
====================
from django.contrib import admin

# Register your models here.


====================
FILE: main\apps.py
====================
from django.apps import AppConfig


class MainConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'main'


====================
FILE: main\models.py
====================
from django.db import models

# Create your models here.


====================
FILE: main\tests.py
====================
from django.test import TestCase

# Create your tests here.


====================
FILE: main\urls.py
====================
from django.urls import path, include
from .views import home, categories

urlpatterns = [
    path("", home, name="home"),
    path("categories/", categories, name="categories"),
]


====================
FILE: main\views.py
====================
from django.shortcuts import render
from catalog.models import Book
from django.db.models import Count

def home(request):
    recently_enriched = (
        Book.objects
        .filter(last_enriched__isnull=False)
        .exclude(cover_image="")
        .order_by("-last_enriched")[:10]
    )

    highly_rated = (
        Book.objects
        .filter(rating_avg__gte=4.0)
        .exclude(cover_image="")
        .order_by("-rating_avg")[:10]
    )

    classics = (
        Book.objects
        .filter(publication_year__lte=1970)
        .exclude(cover_image="")
        .order_by("publication_year")[:15]
    )

    return render(
        request,
        "main/home.html",
        {
            "recently_enriched": recently_enriched,
            "highly_rated": highly_rated,
            "classics": classics,
        }
    )
def categories(request):
    categories = [
        "Fiction",
        "Literature & Fiction",
        "History",
        "Art & Architecture",
        "Science Fiction & Fantasy",
        "Mystery, Thriller & Suspense",
        "Biography & Memoir",
        "Politics & Social Sciences",
        "Philosophy",
        "Religion & Spirituality",
        "Science & Math",
        "Computers & Technology",
        "Business & Economics",
        "Law",
        "Medicine & Health",
        "Travel",
        "Children‚Äôs Books",
        "Teen & Young Adult",
        "Comics & Graphic Novels",
        "Cookbooks, Food & Wine",
        "Self-Help & Psychology",
    ]
    formats = (
        Book.objects
        .exclude(format="")
        .values("format")
        .annotate(count=Count("id"))
        .order_by("format")
    )

    languages = (
        Book.objects
        .exclude(language="")
        .values("language")
        .annotate(count=Count("id"))
        .order_by("language")
    )

    eras = [
        {
            "label": "Classics (Before 1970)",
            "query": "classics",
            "count": Book.objects.filter(publication_year__lte=1970).count(),
        },
        {
            "label": "Modern (1970‚Äì2000)",
            "query": "modern",
            "count": Book.objects.filter(
                publication_year__gt=1970,
                publication_year__lte=2000,
            ).count(),
        },
        {
            "label": "Contemporary (2000+)",
            "query": "contemporary",
            "count": Book.objects.filter(publication_year__gt=2000).count(),
        },
    ]

    reader_favorites = [
        {
            "label": "Highly Rated (4.0+)",
            "query": "highly-rated",
            "count": Book.objects.filter(rating_avg__gte=4.0).count(),
        },
        {
            "label": "Most Wanted",
            "query": "most-wanted",
            "count": Book.objects.filter(want_to_read_count__gte=100).count(),
        },
    ]

    return render(
        request,
        "main/categories.html",
        {
            "categories": categories,
            "formats": formats,
            "languages": languages,
            "eras": eras,
            "reader_favorites": reader_favorites,
        },
    )

====================
FILE: main\__init__.py
====================


====================
FILE: main\templates\main\base.html
====================
<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="utf-8">
    <title>{% block title %}Educated Owl Books{% endblock %}</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100;200;300;400;600;700&display=swap" rel="stylesheet">
    <!-- Favicon -->   
    <link rel="icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">

    {% block extra_css %}{% endblock %}
</head>
<body>

<div class="page-wrapper">

    <header>

        <!-- Top row -->
        <div class="base-header-outer">
            <div class="container base-nav-primary">


                <a href="/" class="base-logo-link">
                    <img src="{% static 'images/modern_logo.png' %}" alt="Logo" height="45">
                    <div class="base-site-title">
                        <h1>Educated Owl Books</h1>
                    </div>
                </a>

                <div class="base-search-bar">
                    <form action="/search/" method="get">
                        <input type="text" name="q" placeholder="Search by title, author, or ISBN‚Ä¶">
                        <button type="submit">SEARCH</button>
                    </form>
                </div>

                <div class="base-user-menu">
                    <select class="base-lang-select">
                        <option>EN</option>
                        <option>ES</option>
                        <option>FR</option>
                        <option>DE</option>
                        <option>IT</option>
                        <option>JA</option>
                        <option>KO</option>
                        <option>PT</option>
                        <option>RU</option>
                    </select>
                    <a href="/login/" class="base-link">Sign In</a>
                    <a href="/login/" class="base-link">Register</a>
                    <a href="/cart/" class="base-link">
                        <i class="fa-solid fa-cart-shopping"></i> (0)
                    </a>
                <button class="mobile-menu-toggle" aria-label="Open menu">
                    <i class="fa-solid fa-bars"></i>
                </button>
                </div>

            </div>
        </div>

        <!-- Primary nav -->
        <div class="base-header-outer">
            <div class="container">
                <div class="base-nav-row-bold split">       

                    <!-- LEFT -->
                    <nav class="base-nav-left">
                        <a href="/search/advanced/" class="base-link">Advanced Search</a>
                        <a href="/textbooks/" class="base-link">Textbooks</a>
                        <a href="/rare-books/" class="base-link">Rare & Collectible</a>
                        <a href="/sellers/" class="base-link">Our Sellers</a>
                    </nav>      

                    <!-- RIGHT -->
                    <a href="/sell/" class="base-sell-link">
                        Sell with us!
                    </a>        

                </div>
            </div>
        </div>

        <!-- Secondary nav -->
         <div class="base-header-outer" style="border-bottom:none;">
            <div class="container">
                <div class="base-nav-row-slim split">

                    <!-- LEFT: menu -->
                    <nav class="base-nav-left">
                        <a href="/categories/" class="base-link">Categories</a>
                        <a href="/trending/" class="base-link">New & Trending</a>
                        <a href="/deals/" class="base-link">Sales & Deals</a>
                        <a href="/best-sellers/" class="base-link">Best Sellers</a>
                    </nav>

                    <!-- RIGHT: subtle marketplace note -->
                    <div class="base-marketplace-note">
                        Prices and Availability are set by our Independent Sellers.
                    </div>

                </div>
            </div>
            </div>

        <!-- Ad banner -->
        <div class="base-ad-wrapper">
            <div class="container">
                <div class="base-ad-content">
                    ADVERTISEMENT BANNER SPACE
                </div>
            </div>
        </div>

    </header>

    <main class="container">
        {% block content %}{% endblock %}
    </main>

    <footer class="container">
        ¬© {% now "Y" %} Educated Owl Books
    </footer>

</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const toggle = document.querySelector(".mobile-menu-toggle");
    const navs = document.querySelectorAll(".base-nav-row-bold, .base-nav-row-slim");

    toggle.addEventListener("click", function () {
        navs.forEach(nav => nav.classList.toggle("active"));
    });
});
</script>

</body>
</html>


====================
FILE: main\templates\main\categories.html
====================
{% extends "main/base.html" %}
{% load static %}

{% block title %}Browse Categories | Educated Owl Books{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/categories.css' %}">
{% endblock %}

{% block content %}
<div class="categories-page">

    <h1>Browse by Category</h1>
    <p class="categories-intro">
        Explore books across history, literature, science, and the arts.
    </p>

    <h2>Fiction & Literature</h2>
    <div class="category-grid">
        {% for name in categories|slice:":7" %}
            <div class="category-card"><h3>{{ name }}</h3></div>
        {% endfor %}
    </div>

    <h2>Nonfiction & Knowledge</h2>
    <div class="category-grid">
        {% for name in categories|slice:"7:15" %}
            <div class="category-card"><h3>{{ name }}</h3></div>
        {% endfor %}
    </div>

    <h2>Arts, Culture & Lifestyle</h2>
    <div class="category-grid">
        {% for name in categories|slice:"15:" %}
            <div class="category-card"><h3>{{ name }}</h3></div>
        {% endfor %}
    </div>

</div>

{% endblock %}


====================
FILE: main\templates\main\home.html
====================
{% extends "main/base.html" %}
{% load static %}

{% block title %}Educated Owl Books{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}

{% block content %}

{% include "main/partials/book_shelf.html" with title="Newly Enriched" books=recently_enriched %}
{% include "main/partials/book_shelf.html" with title="Highly Rated by Readers" books=highly_rated %}
{% include "main/partials/book_shelf.html" with title="Timeless Classics" books=classics %}

<section class="cta-section">
    <a href="{% url 'public_listings' %}" class="base-link">
        <strong>Browse books currently for sale ‚Üí</strong>
    </a>
</section>
<section class="cta-section">
    <p>
        Are you a bookseller?
        <a href="/sellers/">Learn how to list your inventory on Educated Owl Books.</a>
    </p>
</section>


{% endblock %}


====================
FILE: main\templates\main\partials\book_shelf.html
====================
{% if books %}
<div class="home-shelf">
    <h3>{{ title }}</h3>

    <div class="book-grid">
        {% for book in books %}
            <div class="book-item">

                <div class="book-cover">
                    <a href="{% url 'book_detail' book.isbn10|default:book.isbn13 %}">
                        <img src="{{ book.cover_image.url }}" alt="{{ book.title }}">
                    </a>
                </div>

                <div class="book-details">
                    <span class="book-title">
                        {{ book.title|truncatechars:40 }}
                    </span>
                    <span class="book-author">
                        {{ book.author|truncatechars:30 }}
                    </span>
                </div>

            </div>
        {% endfor %}
    </div>
</div>

{% endif %}


====================
FILE: orders\admin.py
====================
from django.contrib import admin

# Register your models here.


====================
FILE: orders\apps.py
====================
from django.apps import AppConfig


class OrdersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'orders'


====================
FILE: orders\models.py
====================
from django.db import models

# Create your models here.


====================
FILE: orders\tests.py
====================
from django.test import TestCase

# Create your tests here.


====================
FILE: orders\urls.py
====================


====================
FILE: orders\views.py
====================
from django.shortcuts import render

# Create your views here.


====================
FILE: orders\__init__.py
====================


====================
FILE: search\admin.py
====================
from django.contrib import admin

# Register your models here.


====================
FILE: search\apps.py
====================
from django.apps import AppConfig


class SearchConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'search'


====================
FILE: search\models.py
====================
from django.db import models

# Create your models here.


====================
FILE: search\tests.py
====================
from django.test import TestCase

# Create your tests here.


====================
FILE: search\urls.py
====================


====================
FILE: search\views.py
====================
from django.shortcuts import render

# Create your views here.


====================
FILE: search\__init__.py
====================

